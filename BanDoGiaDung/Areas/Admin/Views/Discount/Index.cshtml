@using PagedList.Mvc;
@using PagedList;


@model IPagedList<BanDoGiaDung.Models.Discount>
@{
    ViewBag.Title = "Chương trình giảm giá";
    Layout = "~/Areas/Admin/Views/Shared/_MainLayout.cshtml";
}

<link href="~/Content/AdminCSS/Discount/Discount.css" rel="stylesheet" />


<div class="discount-page">

    <!-- HEADER -->
    <div class="page-header">
        <div class="header-left">
            <h4><i class="bi  bi-tags me-2"></i>Chương trình giảm giá</h4>
        </div>
        <div class="header-right">
            <a href="@Url.Action("Create")" class="btn btn-primary">
                <i class="bi bi-plus-lg me-2"></i>Thêm mới
            </a>
        </div>
    </div>

    <!-- SEARCH BAR -->


    <div class="search-bar mb-4">
        <form method="get" class="row g-3">

            <!-- Tìm theo tên -->
            <div class="col-md-3">
                <input type="text" name="search" class="form-control"
                       placeholder="Tìm theo tên..."
                       value="@Request["search"]">
            </div>

            <!-- Tìm theo code -->
            <div class="col-md-3">
                <input type="text" name="code" class="form-control"
                       placeholder="Tìm theo mã code..."
                       value="@Request["code"]">
            </div>

            <!-- Lọc theo trạng thái -->
            <div class="col-md-3">
                @Html.DropDownList("status", new List<SelectListItem>
                {
                    new SelectListItem { Text = "Tất cả trạng thái", Value = "" },
                    new SelectListItem { Text = "Đang hoạt động", Value = "active" },
                    new SelectListItem { Text = "Đã hết hạn", Value = "expired" },
                    new SelectListItem { Text = "Sắp diễn ra", Value = "upcoming" },
                    new SelectListItem { Text = "Hết lượt", Value = "soldout" }
                },
                new { @class = "form-select" })
            </div>

            <!-- Sắp xếp -->
            <div class="col-md-3">
                @Html.DropDownList("sortOrder", new List<SelectListItem>
                {
                    new SelectListItem { Text = "Sắp xếp mặc định", Value = "" },
                    new SelectListItem { Text = "Tên (A → Z)", Value = "name" },
                    new SelectListItem { Text = "Mức giảm cao → thấp", Value = "price" },
                    new SelectListItem { Text = "Số lượng nhiều → ít", Value = "quantity" }
                },
                new { @class = "form-select", onchange = "this.form.submit();" })
            </div>

            <!-- Nút tìm kiếm -->
            <div class="col-md-12 text-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Lọc dữ liệu
                </button>

                <a href="@Url.Action("Index")" class="btn btn-secondary">Xóa lọc</a>
            </div>
        </form>
    </div>


    <!-- TABLE -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th width="80">ID</th>
                            <th>TÊN CHƯƠNG TRÌNH</th>
                            <th width="150">MỨC GIẢM</th>
                            <th width="130">CODE GIẢM GIÁ</th>
                            <th width="100" class="text-center">SỐ LƯỢNG</th>
                            <th width="180">NGÀY TẠO</th>
                            <th width="120">TRẠNG THÁI</th>
                            <th width="150">HÀNH ĐỘNG</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Count > 0)
                        {
                            foreach (var item in Model)
                            {
                                <tr>
                                    <td><strong>@item.disscount_id</strong></td>
                                    <td>
                                        <strong>@item.discount_name</strong>
                                        <br />
                                        <small class="text-muted">
                                            @item.discount_star.ToString("dd/MM/yyyy")
                                            → @item.discount_end.ToString("dd/MM/yyyy")
                                        </small>
                                    </td>
                                    <td>
                                        <span class="text-success fw-bold">
                                            @item.discount_price.ToString("N0")đ
                                        </span>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(item.discount_code))
        {
            <span class="badge bg-white text-dark">@item.discount_code</span>
        }
        else
        {
            <span class="text-muted">-</span>
        }
                                       


                                    </td>
                                    <td class="text-center">
                                        @{ var now = DateTime.Now;

                                            if (item.quantity <= 0)
                                            {
                                                <span class="badge bg-danger text-white">@item.quantity</span>
                                            }
                                            else if (item.discount_end < now)
                                            {
                                                <span class="badge bg-secondary text-white">@item.quantity</span>
                                            }
                                            else if (item.discount_star > now)
                                            {
                                                <span class="badge bg-warning text-dark">@item.quantity</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success text-white">@item.quantity</span>
                                            }
                                        }
                                    </td>
                                    <td>
                                        <small>@item.create_at.ToString("HH:mm dd-MM-yyyy")</small>
                                    </td>

                                    <td>


                                        @{
                                            //var now = DateTime.Now;
                                            string statusLabel = "";
                                            string statusClass = "";

                                            if (item.quantity <= 0)
                                            {
                                                statusLabel = "Hết lượt";
                                                statusClass = "badge bg-danger"; // Màu đỏ
                                            }
                                            else if (item.discount_end < now)
                                            {
                                                statusLabel = "Đã hết hạn";
                                                statusClass = "badge bg-secondary"; // Màu xám
                                            }
                                            else if (item.discount_star > now)
                                            {
                                                statusLabel = "Sắp diễn ra";
                                                statusClass = "badge bg-warning text-dark"; // Màu vàng
                                            }
                                            else
                                            {
                                                statusLabel = "Đang hoạt động";
                                                statusClass = "badge bg-success"; // Màu xanh lá
                                            }
                                        }
                                        <span class="@statusClass">@statusLabel</span>
                                    </td>

                                    <td>
                                        <div class="btn-group">
                                            <a href="@Url.Action("Edit", new { id = item.disscount_id })"
                                               class="btn btn-sm btn-outline-primary"
                                               title="Chỉnh sửa">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <button class="btn btn-sm btn-outline-danger btn-delete"
                                                    data-id="@item.disscount_id"
                                                    data-name="@item.discount_name"
                                                    title="Xóa">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <br />
                                        <span class="badge @item.discount_code mt-1">
                                            @item.discount_code
                                        </span>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <i class="bi bi-inbox" style="font-size: 48px; color: #ddd;"></i>
                                    <p class="text-muted mt-3">Chưa có chương trình giảm giá nào</p>
                                    <a href="@Url.Action("Create")" class="btn btn-primary">
                                        <i class="bi bi-plus-lg me-2"></i>Tạo chương trình đầu tiên
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>


                <!-- PHÂN TRANG Ở ĐÂY -->
                <div class="d-flex justify-content-center mt-4">
                    @Html.PagedListPager(Model, page => Url.Action("Index", new { page, search = Request.QueryString["search"] }))

                </div>





            </div>
        </div>
    </div>

</div>





@section scripts {
    <script>
    $(document).ready(function() {
        // XÓA CHƯƠNG TRÌNH GIẢM GIÁ
        $('.btn-delete').click(function() {
            var id = $(this).data('id');
            var name = $(this).data('name');

            if (confirm('Bạn có chắc muốn xóa chương trình "' + name + '"?')) {
                $.ajax({
                    url: '@Url.Action("Delete")',
                    type: 'POST',
                    data: { id: id },
                    success: function(response) {
                        if (response.success) {
                            toastr.success(response.message);
                            setTimeout(function() {
                                location.reload();
                            }, 1000);
                        } else {
                            toastr.error(response.message);
                        }
                    },
                    error: function() {
                        toastr.error('Có lỗi xảy ra!');
                    }
                });
            }
        });
    });
    </script>
}

