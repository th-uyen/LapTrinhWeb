@model List<BanDoGiaDung.Models.Product>
@using BanDoGiaDung.Models

@{
    Layout = "~/Views/Shared/_LayoutPage.cshtml";

}

<style>
    /* PAGE LAYOUT */
    .product-page {
        max-width: 1350px;
        margin: 30px auto;
        display: grid;
        grid-template-columns: 260px 1fr;
        gap: 30px;
    }

    /* SIDEBAR --------------------------------------------- */
    .sidebar-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 12px;
    }

    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 25px;
    }

    .tag-item {
        padding: 6px 14px;
        border-radius: 20px;
        border: 1px solid #dee2e6;
        background: #f8f9fa;
        font-size: 14px;
        color: #212529;
        transition: .15s;
    }

        .tag-item:hover {
            background: darkgreen;
            color: white;
            border-color: darkgreen;
        }

        .tag-item.active {
            background: darkgreen;
            color: white;
            border-color: darkgreen;
        }

    /* FILTER PRICE */
    .filter-box input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #ced4da;
    }

    .filter-box button {
        width: 100%;
        background: darkgreen;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
    }

    /* SORT BAR --------------------------------------------- */
    .sort-bar {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .sort-btn {
        padding: 6px 16px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        background: white;
        transition: .15s;
    }

        .sort-btn:hover {
            border-color: darkgreen;
            color: darkgreen;
        }

        .sort-btn.active {
            border-color: darkgreen;
            background: darkgreen;
            color: white;
            font-weight: 600;
        }


    /* PRODUCT GRID ----------------------------------------- */
    .grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }

    .product-card {
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #dee2e6;
        background: white;
        text-decoration: none;
        color: inherit;
        transition: .2s;
    }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
        }

        .product-card img {
            width: 100%;
            height: 180px;
            object-fit: contain;
            margin-bottom: 10px;
        }

    .product-name {
        font-weight: 600;
        font-size: 15px;
        min-height: 40px;
        overflow: hidden;
    }

    .product-price {
        color: #e60000;
        font-weight: bold;
        font-size: 17px;
    }

    /* PAGINATION -------------------------------------------- */
    .pagination a {
        border-radius: 8px !important;
        padding: 8px 14px;
        margin: 3px;
        border: 1px solid #dee2e6;
        transition: .15s;
    }

        .pagination a:hover {
            border-color: darkgreen !important;
            color: darkgreen !important;
        }

    .pagination .active > a {
        background: darkgreen !important;
        border-color: darkgreen !important;
        color: white !important;
    }

    a {
        text-decoration: none;
    }
</style>


<div class="product-page">

    <!-- SIDEBAR -->
    <div class="sidebar">

        <!-- BRAND -->
        <div class="sidebar-title" style="margin-top:25px;">HÃNG</div>
        <div id="brandList" class="tag-list"></div>

        <!-- GENRE -->
        <div class="sidebar-title" style="margin-top:25px;">LOẠI SẢN PHẨM</div>
        <div id="genreList" class="tag-list"></div>

    </div>

    <!-- MAIN CONTENT -->
    <div>

        <!-- SORT BAR -->
        <div class="sort-bar">
            <span style="font-weight:bold">Sắp xếp:</span>

            <a onclick="changeSort('')" class="sort-btn">Mặc định</a>
            <a onclick="changeSort('az')" class="sort-btn">A → Z</a>
            <a onclick="changeSort('za')" class="sort-btn">Z → A</a>
            <a onclick="changeSort('price_asc')" class="sort-btn">Giá tăng dần</a>
            <a onclick="changeSort('price_desc')" class="sort-btn">Giá giảm dần</a>
            <a onclick="changeSort('newest')" class="sort-btn">Mới nhất</a>
            <a onclick="changeSort('oldest')" class="sort-btn">Cũ nhất</a>
        </div>

        <!-- PRODUCT GRID -->
        <div id="productGrid" class="grid"></div>

        <!-- PAGINATION -->
        <div id="pagination" style="margin-top:25px; text-align:center;"></div>

    </div>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>

    let filter = {
        brand: null,
        genre: null,
        sort: "default",
        page: 1
    };



    // Load brand + genre
    function loadFilters() {
        $.get("/api/brandapi", function (data) {
            let html = "";
            data.forEach(b => {
                html += `<a class="tag-item" onclick="selectBrand(${b.brand_id})">${b.brand_name}</a>`;
            });
            $("#brandList").html(html);
        });

        $.get("/api/genreapi", function (data) {
            let html = "";
            data.forEach(g => {
                html += `<a class="tag-item" onclick="selectGenre(${g.genre_id})">${g.genre_name}</a>`;
            });
            $("#genreList").html(html);
        });
    }

    function selectBrand(id) {
        filter.brand = id;
        filter.genre = null;       // 🔥 reset genre
        filter.page = 1;           // 🔥 reset trang
        filter.sort = "default";   // 🔥 reset sort

        loadProducts();
    }


    function selectGenre(id) {
        filter.genre = id;
        filter.brand = null;       // 🔥 reset brand
        filter.page = 1;
        filter.sort = "default";

        loadProducts();
    }


    function changeSort(type) {
        filter.sort = type || "default";
        filter.page = 1;
        loadProducts();
    }

    

    // Load sản phẩm
    // Load sản phẩm theo bộ lọc hiện tại
    function loadProducts() {

        // Tạo object gửi lên API, chỉ gửi những param cần thiết
        let sendData = {
            page: filter.page
        };

        if (filter.brand !== null) sendData.brand = filter.brand;
        if (filter.genre !== null) sendData.genre = filter.genre;
        if (filter.sort && filter.sort !== "default") sendData.sort = filter.sort;

        $.ajax({
            url: "/api/productapi",
            method: "GET",
            data: sendData,
            success: function (res) {

                console.log("Response API:", res);   // xem thử trong Console

                // Nếu không có dữ liệu
                if (!res || !res.data || res.data.length === 0) {
                    $("#productGrid").html("<p>Không có sản phẩm phù hợp.</p>");
                    $("#pagination").html("");
                    return;
                }

                // -------- Render SẢN PHẨM ----------
                let html = "";
                res.data.forEach(p => {
                    html += `
                    <a class="product-card" href="/Product/Details/${p.product_id}">
                        <img src="${p.image}" />
                        <div class="product-name">${p.product_name}</div>
                        <div class="product-price">${p.price.toLocaleString()} ₫</div>
                    </a>`;
                });

                $("#productGrid").html(html);

                // -------- Render PHÂN TRANG ----------
                let pag = "";
                for (let i = 1; i <= res.totalPage; i++) {
                    pag += `
                    <a onclick="goPage(${i})"
                       style="padding:8px 14px; border:1px solid #ddd; margin:3px; border-radius:6px;
                              background:${i === res.page ? 'darkgreen' : 'white'};
                              color:${i === res.page ? 'white' : 'black'};
                              cursor:pointer;">
                        ${i}
                    </a>
                `;
                }
                $("#pagination").html(pag);
            },
            error: function (err) {
                console.log("Lỗi API:", err);
            }
        });
    }


    // Chuyển trang
    function goPage(i) {
        filter.page = i;
        loadProducts();
    }

    $(document).ready(function () {
        loadFilters();   // load brand + genre
        loadProducts();  // load danh sách ban đầu
    });


</script>